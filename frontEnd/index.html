<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <title>IPæº¯æºå®šä½</title>

    <!-- è‡ªå®šä¹‰ç½‘ç«™å›¾æ ‡ -->
    <link rel="icon" href="webIcon.png" type="image/png">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Leaflet åœ°å›¾ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        /* ç§‘å¹»å­—ä½“ */
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');

        body {
            margin: 0;
            padding: 2rem;
            font-family: 'Roboto Mono', monospace;
            background-color: #1a1a1a;
            color: white;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        .light-mode body {
            background-color: white;
            color: black;
        }

        h2 {
            text-align: center;
            color: white;
            text-shadow: 0 0 10px #00ff00;
        }

        .light-mode h2 {
            color: black;
            text-shadow: none;
        }

        .input-group input {
            background-color: #1a1a1a;
            color: white;
            border: 1px solid #00ff00;
        }

        .light-mode .input-group input {
            background-color: white;
            color: black;
            border: 1px solid #666;
        }

        .btn-primary {
            background-color: #00ff00;
            color: black;
            border: none;
            box-shadow: 0 0 10px #006400;
        }

        .btn-outline-secondary {
            color: #00ff00;
            border-color: #00ff00;
            box-shadow: 0 0 5px #006400;
        }

        .card {
            background-color: #1a1a1a;
            border: 1px solid #00ff00;
        }

        .light-mode .card {
            background-color: white;
            border: 1px solid #ccc;
        }

        .card-header {
            background-color: #002200;
            color: #00ff00;
            font-weight: bold;
        }

        .light-mode .card-header {
            background-color: #f8f8f8;
            color: black;
        }

        .list-group-item {
            background-color: #1a1a1a;
            color: white;
            border: none;
            border-bottom: 1px dashed #00ff00;
        }

        .light-mode .list-group-item {
            background-color: white;
            color: black;
            border-bottom: 1px dashed #ccc;
        }

        #map {
            height: 300px;
            background-color: #1a1a1a;
        }

        .footer-info {
            margin-top: 3rem;
            text-align: center;
            font-size: 0.9rem;
            color: #cccccc;
        }

        a#baiduMapLink {
            color: #00ff00;
            text-decoration: underline;
        }

        .light-mode a#baiduMapLink {
            color: blue;
        }

        /* é»‘å®¢é£æ ¼èƒŒæ™¯åŠ¨ç”» */
        canvas#matrixCanvas {
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
            pointer-events: none;
        }
    </style>
</head>
<body>

<canvas id="matrixCanvas"></canvas>

<!-- é¡µé¢ä¸»ä½“ -->
<div class="container">
    <h2>IPæº¯æºå®šä½</h2>

    <div class="input-group mb-3">
        <input type="text" id="ipInput" class="form-control" placeholder="è¯·è¾“å…¥ IP åœ°å€" value="8.8.8.8">
        <button class="btn btn-primary" onclick="queryIpInfo()">æŸ¥è¯¢</button>
        <button class="btn btn-outline-secondary" onclick="toggleDarkMode()">åˆ‡æ¢è‡³æ˜äº®æ¨¡å¼</button>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">ğŸŒ åœ°ç†ä¿¡æ¯</div>
                <ul class="list-group list-group-flush" id="geoInfo">
                    <li class="list-group-item">æš‚æ— æ•°æ®</li>
                </ul>
            </div>

            <div class="card">
                <div class="card-header">ğŸŒ¤ï¸ å½“åœ°å¤©æ°”</div>
                <ul class="list-group list-group-flush" id="weatherInfo">
                    <li class="list-group-item">æš‚æ— æ•°æ®</li>
                </ul>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">ğŸ—ºï¸ åœ°å›¾é¢„è§ˆ</div>
                <div id="map"></div>
                <div class="card-footer">
                    <a href="#" id="baiduMapLink" target="_blank">åœ¨ç™¾åº¦åœ°å›¾ä¸­æ‰“å¼€</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ä½œè€…ä¿¡æ¯ | ç‰ˆæœ¬å· | æ³¨æ„äº‹é¡¹ -->
<div class="footer-info">
    <p>ä½œè€…ï¼škillLog | ç‰ˆæœ¬ï¼šv1.0.0</p>
    <p>éœ€è¦çš„æŠ€æœ¯å’Œå·¥å…·ï¼šjavaã€è®¡ç®—æœºç½‘ç»œã€htmlã€cssã€javaScriptã€mavenã€IDEAã€Vscodeã€WireSharkï¼›å¤©æ°”æ•°æ®æ¥è‡ª Open-Meteoï¼Œæ— éœ€ API Keyã€‚</p>
</div>

<!-- Matrix åŠ¨ç”»è„šæœ¬ -->
<script>
    const canvas = document.getElementById("matrixCanvas");
    const ctx = canvas.getContext("2d");

    // è®¾ç½® canvas å¤§å°
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const letters = "01";
    const fontSize = 16;
    const columns = canvas.width / fontSize;
    const drops = Array(Math.floor(columns)).fill(1);

    function draw() {
        ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#006400"; // æ›´æš—çš„ç»¿è‰²
        ctx.font = fontSize + "px monospace";

        for (let i = 0; i < drops.length; i++) {
            const text = letters.charAt(Math.floor(Math.random() * letters.length));
            ctx.fillText(text, i * fontSize, drops[i] * fontSize);

            if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                drops[i] = 0;
            }

            drops[i]++;
        }
    }

    setInterval(draw, 50);

    window.addEventListener("resize", () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });
</script>

<!-- ä¸»è¦é€»è¾‘è„šæœ¬ -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // åˆå§‹åŒ–åœ°å›¾
    let map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    function toggleDarkMode() {
        document.body.classList.toggle('light-mode');

        // ä¿®æ”¹æŒ‰é’®æ–‡å­—
        const button = document.querySelector("button[onclick='toggleDarkMode()']");
        if (document.body.classList.contains('light-mode')) {
            button.textContent = "åˆ‡æ¢è‡³é»‘æš—æ¨¡å¼";
        } else {
            button.textContent = "åˆ‡æ¢è‡³æ˜äº®æ¨¡å¼";
        }
    }

    async function queryIpInfo() {
        const ip = document.getElementById("ipInput").value;
        try {
            const res = await fetch(`http://localhost:8080/api/ipinfo?ip=${ip}`);
            const data = await res.json();

            if (data.status === "success") {
                updateGeoInfo(data);
                updateWeatherInfo(data.lat, data.lon); // ä½¿ç”¨ç»çº¬åº¦æŸ¥è¯¢å¤©æ°”
                updateMap(data.lat, data.lon, data.city);
                updateBaiduMapLink(data.lat, data.lon);
            } else {
                alert("æŸ¥è¯¢å¤±è´¥ï¼š" + JSON.stringify(data));
            }
        } catch (e) {
            console.error(e);
            alert("è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨");
        }
    }

    function updateGeoInfo(data) {
        const container = document.getElementById("geoInfo");
        container.innerHTML = `
            <li class="list-group-item"><strong>IPï¼š</strong>${data.query}</li>
            <li class="list-group-item"><strong>å›½å®¶/åœ°åŒºï¼š</strong>${data.country} (${data.countryCode})</li>
            <li class="list-group-item"><strong>çœä»½/åŸå¸‚ï¼š</strong>${data.regionName} / ${data.city}</li>
            <li class="list-group-item"><strong>è¿è¥å•†ï¼š</strong>${data.isp}</li>
            <li class="list-group-item"><strong>ç»çº¬åº¦ï¼š</strong>${data.lat}, ${data.lon}</li>
            <li class="list-group-item"><strong>æ—¶åŒºï¼š</strong>${data.timezone}</li>
        `;
    }

    async function updateWeatherInfo(lat, lon) {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&temperature_unit=celsius&windspeed_unit=kmh`;

        try {
            const res = await fetch(url);
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            const weatherData = await res.json();

            const current = weatherData.current_weather;

            const container = document.getElementById("weatherInfo");
            container.innerHTML = `
                <li class="list-group-item"><strong>å¤©æ°”ä»£ç ï¼š</strong>${current.weathercode}</li>
                <li class="list-group-item">ğŸŒ¡ï¸ æ¸©åº¦ï¼š${current.temperature}â„ƒ</li>
                <li class="list-group-item">ğŸŒ¬ï¸ é£é€Ÿï¼š${current.windspeed} km/h</li>
                <li class="list-group-item">ğŸ§­ é£å‘ï¼š${current.winddirection}Â°</li>
            `;
        } catch (e) {
            console.error(e);
            document.getElementById("weatherInfo").innerHTML = "<li class='list-group-item'>å¤©æ°”æŸ¥è¯¢å¤±è´¥: " + e.message + "</li>";
        }
    }

    function updateMap(lat, lon, city) {
        map.setView([lat, lon], 10);
        map.eachLayer(layer => {
            if (layer instanceof L.Marker) {
                map.removeLayer(layer);
            }
        });
        L.marker([lat, lon]).addTo(map).bindPopup(city).openPopup();
    }

    function updateBaiduMapLink(lat, lon) {
        const link = `https://map.baidu.com/poi/index?qt=poi&extype=detail&cid=0&wd=${lat},${lon}`;
        document.getElementById("baiduMapLink").href = link;
    }
</script>

</body>
</html>